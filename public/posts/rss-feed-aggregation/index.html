<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>RSS Feed aggregation :: dntiontk.github.io</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="This post is related to my previous post about civic code. I mentioned that there are multiple RSS feeds that the city maintains, and that this data is not particularly easy to find and parse.
We are going to create an RSS feed aggregator creates a weekly summary and automatically creates a new post on this blog.
The data First, we need to identify which feeds we&amp;rsquo;ll be using. For now, we are going to keep the list small, however we expect that there will be more sources as time goes on:" />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="/posts/rss-feed-aggregation/" />




<link rel="stylesheet" href="/assets/style.css">

  <link rel="stylesheet" href="/assets/blue.css">






<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="/img/favicon/blue.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="RSS Feed aggregation :: dntiontk.github.io">
<meta property="og:description" content="This post is related to my previous post about civic code. I mentioned that there are multiple RSS feeds that the city maintains, and that this data is not particularly easy to find and parse.
We are going to create an RSS feed aggregator creates a weekly summary and automatically creates a new post on this blog.
The data First, we need to identify which feeds we&amp;rsquo;ll be using. For now, we are going to keep the list small, however we expect that there will be more sources as time goes on:" />
<meta property="og:url" content="/posts/rss-feed-aggregation/" />
<meta property="og:site_name" content="RSS Feed aggregation" />

  <meta property="og:image" content="/">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2023-04-03 00:00:00 &#43;0000 UTC" />












</head>
<body class="blue">


<div class="container headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    dntiontk.github.io
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/showcase">Showcase</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/showcase">Showcase</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="/posts/rss-feed-aggregation/">RSS Feed aggregation</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2023-04-03 
      </span>
    
    
    <span class="post-author">:: dev</span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="/tags/code/">code</a>&nbsp;
    
    #<a href="/tags/windsor/">windsor</a>&nbsp;
    
    #<a href="/tags/rss/">rss</a>&nbsp;
    
    #<a href="/tags/aggregation/">aggregation</a>&nbsp;
    
    #<a href="/tags/news/">news</a>&nbsp;
    
    #<a href="/tags/civics/">civics</a>&nbsp;
    
  </span>
  

  

  

  <div class="post-content"><div>
        <p>This post is related to my previous post about <a href="/posts/civic-code/">civic code</a>. I mentioned that there are multiple RSS feeds that the city maintains, and that this data is not particularly easy to find and parse.</p>
<p>We are going to create an RSS feed aggregator creates a weekly summary and automatically creates a new post on this blog.</p>
<h2 id="the-data">The data<a href="#the-data" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>First, we need to identify which feeds we&rsquo;ll be using. For now, we are going to keep the list small, however we expect that there will be more sources as time goes on:</p>
<ul>
<li>City of Windsor Newsroom -&gt; <a href="https://www.citywindsor.ca/Pages/RssFeed.aspx?Catalogue=News">https://www.citywindsor.ca/Pages/RssFeed.aspx?Catalogue=News</a></li>
<li>City of Windsor Open Data Catalogue -&gt; <a href="https://opendata.citywindsor.ca/RSS">https://opendata.citywindsor.ca/RSS</a></li>
</ul>
<p>I like to make a quick prototype out the expected output before beginning development. I typically keep it quick and dirty, with just enough information to get started.</p>
<p>The output will look something like:</p>
<pre><code>### Weekly summary for {week}

#### News
- itemized list of changes from [previous week](link to previous week)

#### Open Data Catalogue
- itemized list of changes from [previous week](link to previous week)
</code></pre><h2 id="the-process">The process<a href="#the-process" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>The flow we expect to use is that our aggregator fetches the current raw feed (if it exists) from its local storage. It compares the local copy to the remote copy of the feed and uses that data to summarize the changes over the past week. The summary is published as a <code>hugo content post</code>, the local feed state is updated, and a commit is pushed via git.</p>
<h2 id="the-aggregator">The aggregator<a href="#the-aggregator" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>As I started to explore the Open Data catalogue, I found something that suprised me, although in retrospect, I should have known. The Open Data RSS feed is <strong>horribly</strong> maintained. It seems that files are uploaded frequently, but there is no metadata. Basically, every item has a title, a link (usually a YTD .csv file) and a publish date.</p>
<p>Before we get to the code, I&rsquo;m going to go on a little bit of a rant. City-based Open Data catalogues provide an incredible opportunity for a city to grow, become more resilient, and make effective and positive change. We can better understand and address the issues that affect our communities. We can make intelligent and informed decisions, and really take control of our collective destiny.</p>
<p>Anyway, here is the data structure of the 5th item in the feed:</p>
<pre><code>{
    &quot;title&quot;: &quot;05 Grand Marais.csv&quot;,
    &quot;link&quot;: &quot;http://opendata.citywindsor.ca/uploads/05 Grand Marais.csv&quot;,
    &quot;links&quot;: [
        &quot;http://opendata.citywindsor.ca/uploads/05 Grand Marais.csv&quot;
    ],
    &quot;pubDate&quot;: &quot;3/23/2023 2:46:24 PM&quot;,
    &quot;pubDateParsed&quot;: &quot;2023-03-23T14:46:24Z&quot;
}
</code></pre><p><em>What is this?</em> After doing a bit of digging, I found out that its <strong>precipitation</strong> data from the Grand Marais Rd. precipitation gauge.</p>
<p>And this is what I mean when I say that it feels like they&rsquo;ve made it intentionally bad.</p>
<hr>
<p>Now let&rsquo;s get to the code. We have a pretty simple program for the most part.</p>
<p>First we parse the local copy of the Open Data feed. If it doesn&rsquo;t exist, we return an empty feed. We then add each item to a map with a formatted timestamp.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// main.go#61-80
</span><span style="color:#75715e">// Parse our local copy of the opendata feed
</span><span style="color:#75715e"></span><span style="color:#a6e22e">localOpendataFeed</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">opendataFeed</span>.<span style="color:#a6e22e">parseLocalFeed</span>()
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
}

<span style="color:#a6e22e">itemMap</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>)

<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">item</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">localOpendataFeed</span>.<span style="color:#a6e22e">Items</span> {
	<span style="color:#a6e22e">formatted</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">item</span>.<span style="color:#a6e22e">PubDateParsed</span>.<span style="color:#a6e22e">Format</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">RFC3339</span>)
	<span style="color:#a6e22e">pubDate</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">RFC3339</span>, <span style="color:#a6e22e">formatted</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;unable to parse date from local feed: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">itemMap</span>[<span style="color:#a6e22e">item</span>.<span style="color:#a6e22e">Title</span>] = <span style="color:#a6e22e">pubDate</span>
}
</code></pre></div><p>Next we parse the remote feed, and write the XML data to a file. We&rsquo;re going to use a data type we&rsquo;ll call <code>FeedConfig</code> to simplify this process.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// main.go#147-167
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">fc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">FeedConfig</span>) <span style="color:#a6e22e">parseRemoteFeed</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Client</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">rss</span>.<span style="color:#a6e22e">Feed</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">fc</span>.<span style="color:#a6e22e">url</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;unable to get remote feed: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Body</span>.<span style="color:#a6e22e">Close</span>()

	<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadAll</span>(<span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Body</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fc</span>.<span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">data</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">feed</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fc</span>.<span style="color:#a6e22e">parseRSSFeed</span>(<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">NewBuffer</span>(<span style="color:#a6e22e">data</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;unable to parse remote feed: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">feed</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>Lastly, we lookup each item in the map we created earlier. If the item is not in the map, we add it to our updated items list. If the item is in the map, but the timestamps don&rsquo;t match, we add it to updated items list.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// main#103-120
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">lookupUpdates</span>(<span style="color:#a6e22e">m</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>, <span style="color:#a6e22e">items</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">rss</span>.<span style="color:#a6e22e">Item</span>) ([]<span style="color:#f92672">*</span><span style="color:#a6e22e">rss</span>.<span style="color:#a6e22e">Item</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">out</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">rss</span>.<span style="color:#a6e22e">Item</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">items</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">date</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">i</span>.<span style="color:#a6e22e">Title</span>]; <span style="color:#a6e22e">ok</span> {
			<span style="color:#a6e22e">formatted</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">i</span>.<span style="color:#a6e22e">PubDateParsed</span>.<span style="color:#a6e22e">Format</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">RFC3339</span>)
			<span style="color:#a6e22e">rDate</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">RFC3339</span>, <span style="color:#a6e22e">formatted</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
			}
			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">rDate</span>.<span style="color:#a6e22e">Equal</span>(<span style="color:#a6e22e">date</span>) {
				<span style="color:#a6e22e">out</span> = append(<span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">i</span>)
			}
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#a6e22e">out</span> = append(<span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">i</span>)
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">out</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>To see the full code, go to <a href="https://github.com/dntiontk/dntiontk.github.io/code/rss-feed-aggregator">https://github.com/dntiontk/dntiontk.github.io/code/rss-feed-aggregator</a></p>
<p>Next time, we&rsquo;ll work on setting up our <strong>publisher</strong> Github Action to generate a new hugo post and commit the change. We&rsquo;ll also try adding in our Newsroom feed.</p>
<hr>
<p><strong>Keep coding with purpose!  ::dev</strong></p>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        
        <span class="button next">
            <a href="/posts/civic-code/">
                <span class="button__text">civic code</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2023 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>





  
</div>

</body>
</html>
